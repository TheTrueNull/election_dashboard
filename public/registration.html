<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Registration</title>
    <link rel="stylesheet" href="registration.css">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
</head>
<body>
    <!-- particles.js container -->
    <div id="particles-js"></div>

    <div class="card">
        <h2>User Registration</h2>
        <form id="registrationForm">
          <label for="username">Username:</label>
          <input type="text" id="username" name="username" required>
      
          <label for="email">Email:</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            pattern="^[a-zA-Z0-9._%+-]+@(csun\.edu|my\.csun\.edu)$"
            title="Email must end with @csun.edu or @my.csun.edu"
          >
          <small>Email must end with <strong>@csun.edu</strong> or <strong>@my.csun.edu</strong></small>
      
          <label for="password">Password:</label>
          <input type="password" id="password" name="password" required>
      
          <label for="confirmPassword">Confirm Password:</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required>
      
          <button type="submit">Register</button>
        </form>
        <div id="redirect-box" class="fade-box">
            Registration successful! Redirecting to sign in...
          </div>          
        <p>Already registered? <a href="signin.html">Sign in here</a></p>
      </div>
      

    <!-- stats - count particles -->
    <div class="count-particles"> <span class="js-count-particles"></span></div>

    <script>
        // Initialize particles.js
        particlesJS.load('particles-js', 'particlesjs-config.json', function() {
            console.log('callback - particles.js config loaded');
        });

        // Check if there's an error or success message in the URL query
        const urlParams = new URLSearchParams(window.location.search);
        const errorMessage = urlParams.get('error');
        const successMessage = urlParams.get('message');

        if (errorMessage) {
            document.getElementById('error-message').textContent = decodeURIComponent(errorMessage);
            document.getElementById('error-message').style.display = 'block';
        }

        if (successMessage) {
            document.getElementById('success-message').textContent = decodeURIComponent(successMessage);
            document.getElementById('success-message').style.display = 'block';
        }
        const emailInput = document.getElementById('email');
        const errorMsg = document.getElementById('emailError');
        emailInput.addEventListener('input', () => {
            const valid = /^[a-zA-Z0-9._%+-]+@(csun\.edu|my\.csun\.edu)$/.test(emailInput.value);
            errorMsg.style.display = valid ? 'none' : 'inline';
        });
        function validateEmail() {
            const valid = /^[a-zA-Z0-9._%+-]+@(csun\.edu|my\.csun\.edu)$/.test(emailInput.value);
            if (!valid) {
                errorMsg.style.display = 'inline';
                return false;
            }
            return true;
        }
        document.getElementById('registrationForm').addEventListener('submit', function (e) {
    e.preventDefault(); // Prevent page reload

    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (password !== confirmPassword) {
      alert("Passwords do not match.");
      return;
    }

    fetch('/api/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ username, email, password })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
            const box = document.getElementById('redirect-box');
            box.classList.add('show');
          setTimeout(() => {
            window.location.href = 'signin.html';
        }, 3000);
        } else {
          alert(data.message || "Registration failed.");
        }
      })
      .catch(err => {
        console.error("Error during registration:", err);
        alert("Something went wrong. Try again later.");
      });
  });
    </script>
</body>
</html>
